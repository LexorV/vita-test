import{m as j,n as A,_ as S,f as D,h as w,g as F,i as L,j as q,k as N,l as z,e as M}from"./CommentForm.vue_vue_type_style_index_0_scoped_fe3fdbb5_lang-OKrdhW-x.js";import{C as $,x as f,y as i,z as l,A as t,L as r,G as d,Q as P,a as U,K as R,t as E,r as b,P as C,M as G,R as H,S as Q,n as J,O as K,F as g,H as x,D as I,I as T,J as O}from"./index-DlmhaCa1.js";import{Q as W}from"./QPage-DSBNIFOy.js";import{api as V}from"./axios-CBiA5BwK.js";const X={class:"row items-center justify-between q-mb-xs"},Y={class:"col"},Z={class:"text-subtitle2"},ee={class:"text-caption text-grey-7"},te={class:"col-auto row items-center q-gutter-xs"},se={class:"text-caption text-grey-6"},ae={class:"text-body2"},oe=$({__name:"CommentComponent",props:{comment:{}},emits:["delete"],setup(y,{emit:c}){const p=y,e=c;function o(){e("delete",p.comment.id)}return(s,m)=>(i(),f(j,null,{default:l(()=>[t(A,null,{default:l(()=>[r("div",X,[r("div",Y,[r("div",Z,d(s.comment.userInfo),1),r("div",ee,d(s.comment.email),1)]),r("div",te,[r("div",se,d(s.comment.dateTime),1),t(P,{flat:"",round:"",dense:"",icon:"delete_outline",color:"negative",onClick:o,"aria-label":"Удалить комментарий"})])]),r("div",ae,d(s.comment.textComment),1)]),_:1})]),_:1}))}}),ne=S(oe,[["__scopeId","data-v-40b1c62a"]]),le={class:"col"},ie={class:"text-h6"},re={class:"text-caption text-grey-7"},me={class:"col-auto text-caption text-grey-6"},ue=$({__name:"PostCard",props:{post:{}},setup(y){const c=y,p=R(),e=U(()=>c.post.briefDescription);function o(){p.push({path:`/post/${c.post.id}`})}return(s,m)=>(i(),f(D,{class:"q-mb-md cursor-pointer",onClick:o},{default:l(()=>[t(w,{class:"row items-center justify-between"},{default:l(()=>[r("div",le,[r("div",ie,d(s.post.title),1),r("div",re,d(e.value),1)]),r("div",me,d(s.post.dateTime),1)]),_:1}),t(F)]),_:1}))}}),de=S(ue,[["__scopeId","data-v-9cb39111"]]),ce=$({__name:"CommentForm",props:{postId:{}},emits:["submitted"],setup(y,{emit:c}){const p=y,e=c,o=E({userInfo:"",email:"",textComment:""}),s=b(!1),m=b(null),v={required:n=>n&&n.toString().trim().length>0||"Обязательное поле",max50:n=>!n||n.length<=50||"Максимум 50 символов",max255:n=>!n||n.length<=255||"Максимум 255 символов",email:n=>n?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)||"Некорректный email":!0};async function k(){if(!m.value)return;const n=m.value.validate();if(typeof n=="boolean"?n:await n){s.value=!0;try{const a={...o},{data:_}=await V.post("/comment",a,{params:{postId:p.postId}});e("submitted",_),o.userInfo="",o.email="",o.textComment="",m.value&&m.value.resetValidation(),Q.create({type:"positive",message:"Комментарий добавлен"})}catch(a){console.error("Не удалось добавить комментарий",a),Q.create({type:"negative",message:"Не удалось добавить комментарий"})}finally{s.value=!1}}}return(n,u)=>(i(),f(D,{class:"form-card",bordered:""},{default:l(()=>[t(w,{class:"row items-center q-gutter-sm"},{default:l(()=>[t(C,{name:"chat_bubble_outline",color:"primary",size:"28px"}),u[3]||(u[3]=r("div",{class:"text-h6"},"Добавить комментарий",-1))]),_:1,__:[3]}),t(F,{spaced:""}),t(w,null,{default:l(()=>[t(L,{onSubmit:G(k,["prevent"]),class:"q-gutter-md",ref_key:"formRef",ref:m},{default:l(()=>[t(q,{modelValue:o.userInfo,"onUpdate:modelValue":u[0]||(u[0]=a=>o.userInfo=a),label:"Имя",outlined:"",rules:[v.required,v.max50],disable:s.value,maxlength:"50",hint:"До 50 символов"},{prepend:l(()=>[t(C,{name:"person"})]),_:1},8,["modelValue","rules","disable"]),t(q,{modelValue:o.email,"onUpdate:modelValue":u[1]||(u[1]=a=>o.email=a),label:"Email",type:"email",outlined:"",rules:[v.email,v.max50],disable:s.value,maxlength:"50",hint:"Например: name@example.com"},{prepend:l(()=>[t(C,{name:"email"})]),_:1},8,["modelValue","rules","disable"]),t(q,{modelValue:o.textComment,"onUpdate:modelValue":u[2]||(u[2]=a=>o.textComment=a),label:"Комментарий",type:"textarea",autogrow:"",outlined:"",rules:[v.required,v.max255],disable:s.value,maxlength:"255",hint:"До 255 символов"},{prepend:l(()=>[t(C,{name:"comment"})]),_:1},8,["modelValue","rules","disable"]),t(N,{align:"right",class:"q-pa-none"},{default:l(()=>[t(P,{label:"Добавить комментарий",type:"submit",color:"primary",loading:s.value,icon:"send",unelevated:""},null,8,["loading"])]),_:1})]),_:1},512)]),_:1}),t(z,{showing:s.value},{default:l(()=>[t(H,{size:"42px",color:"primary"})]),_:1},8,["showing"])]),_:1}))}}),pe=S(ce,[["__scopeId","data-v-fe3fdbb5"]]),ve={key:0,class:"q-pa-md"},_e={key:1,class:"q-pa-md text-negative"},fe={key:2,class:"q-pa-md"},ge={class:"text-body1"},ye={class:"row items-center justify-between q-mb-md"},be={class:"text-subtitle1"},he={key:0,class:"q-mb-md"},xe={key:0,class:"q-pa-md text-grey"},qe=$({__name:"PostPage",setup(y){const c=K(),p=R(),e=b(null),o=b(!1),s=b(null),m=b(!1);async function v(){const a=c.params.id;if(!a){p.replace("/");return}o.value=!0,s.value=null;try{const{data:_}=await V.get(`/post/${a}`);e.value=_??null,e.value&&Array.isArray(e.value.comments)&&(e.value.comments=[...e.value.comments].sort((h,B)=>new Date(B.dateTime).getTime()-new Date(h.dateTime).getTime())),e.value||p.replace("/")}catch{s.value="Не удалось загрузить пост"}finally{o.value=!1}}function k(a){e.value&&(e.value.comments=[a,...e.value.comments||[]])}J(v);function n(a){k(a),m.value=!1}async function u(a){if(e.value)try{await V.delete(`/comment/${a}`),e.value.comments=(e.value.comments||[]).filter(_=>_.id!==a)}catch{Q.create({type:"negative",message:"Не удалось удалить комментарий"})}}return(a,_)=>(i(),f(W,{padding:""},{default:l(()=>[o.value?(i(),g("div",ve,"Загрузка...")):s.value?(i(),g("div",_e,d(s.value),1)):e.value?(i(),g(T,{key:3},[t(I(de),{post:e.value},null,8,["post"]),t(D,{class:"q-mb-lg"},{default:l(()=>[e.value.fullDescription?(i(),f(w,{key:0},{default:l(()=>[r("div",ge,d(e.value.fullDescription),1)]),_:1})):x("",!0)]),_:1}),r("div",ye,[r("div",be,"Комментарии ("+d(e.value.comments?.length??0)+")",1),m.value?x("",!0):(i(),f(P,{key:0,color:"primary",label:"Добавить комментарий",onClick:_[0]||(_[0]=h=>m.value=!0)}))]),m.value?(i(),g("div",he,[e.value?(i(),f(I(pe),{key:0,"post-id":e.value.id,onSubmitted:n},null,8,["post-id"])):x("",!0)])):x("",!0),t(M,{bordered:"",separator:"",class:"q-mb-lg"},{default:l(()=>[(i(!0),g(T,null,O(e.value.comments||[],h=>(i(),f(I(ne),{key:h.id,comment:h,onDelete:u},null,8,["comment"]))),128)),!e.value.comments||e.value.comments.length===0?(i(),g("div",xe," Комментариев пока нет ")):x("",!0)]),_:1})],64)):(i(),g("div",fe,"Пост не найден"))]),_:1}))}});export{qe as default};
